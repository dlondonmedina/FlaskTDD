<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>6. TDD Online - Test-Driven Development with Flask</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Test-Driven Development with Flask</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">One <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ch1/" class="dropdown-item">1. Intro to TDD</a>
</li>
                                    
<li>
    <a href="../ch2/" class="dropdown-item">2. Types of Tests</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Two <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ch3/" class="dropdown-item">3. Intro to Objects</a>
</li>
                                    
<li>
    <a href="../ch4/" class="dropdown-item">4. TDD with Objects</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Three <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ch5/" class="dropdown-item">5. The Internet</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">6. TDD Online</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Four <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ch7/" class="dropdown-item">7. Intro to Flask</a>
</li>
                                    
<li>
    <a href="../ch8/" class="dropdown-item">8. Smallest App</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Five <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ch9/" class="dropdown-item">9. Intro to HTML</a>
</li>
                                    
<li>
    <a href="../ch10/" class="dropdown-item">10. Intro to Templates</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Six <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ch11/" class="dropdown-item">11. Decorators</a>
</li>
                                    
<li>
    <a href="../ch12/" class="dropdown-item">12. Templates the TDD Way</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Seven <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ch13/" class="dropdown-item">13. Forms the TDD way</a>
</li>
                                    
<li>
    <a href="../ch14/" class="dropdown-item">14. Databases and Login</a>
</li>
                                    
<li>
    <a href="../ch15/" class="dropdown-item">15. Building our Blog</a>
</li>
                                    
<li>
    <a href="../ch16/" class="dropdown-item">16. Finishing the Blog</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../ch5/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ch7/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#test-driven-design-and-the-web" class="nav-link">Test Driven Design and the Web</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="test-driven-design-and-the-web">Test Driven Design and the Web</h1>
<p>Before we move into Flask, I want to walk through an exercise of how we might develop a quick web client using the <a href="https://requests.readthedocs.io/en/master/">requests</a> library and the test driven design approach.</p>
<p>First, I have set up a resource at http://computingconcepts.herokuapp.com that returns status codes based on the request it receives. I built this as a toy to help students experiment with the requests library, and so it does the following:</p>
<ul>
<li>
<p>If it receives a GET request it will respond.</p>
</li>
<li>
<p>If that GET request is accompanied by a user-agent called 'DICE' then it will return the string 44260953 in the body of the response</p>
</li>
<li>
<p>The application is set up to handle POST requests at the resource named 'post', so the complete URL should be https://computingconcepts.herokuapp.com/post and if it received a POST request it will check the data. If the data is <code>{'username': 'bobby', 'email': 'bobby@bobby.com'}</code> then it will return the string 44261853 in the body of the response. If the data is wrong, it will return "You didn't submit the right data"  </p>
</li>
</ul>
<p>The specifications of my assignment is the following:</p>
<ol>
<li>
<p>Build three functions: basic_request(), request_user_agent(), and request_post()</p>
</li>
<li>
<p>basic_request takes one parameter: a URL. Uses requests to make a GET request to the URL. It returns -1 if the status code response from the URL is anything but 200, otherwise it returns 200.</p>
</li>
<li>
<p>request_user_agent() takes 2 parameters, a URL and a user agent. It uses requests to make a GET request to the URL with the user agent defined. If the URL is bad or the user agent is not set, it will return -1. Otherwise, it will return the content of the response. I know the server above, so I can test this.</p>
</li>
<li>
<p>request_post() takes 2 parameters, a URL and a data object (probably dictionary). If the URL is bad or if no data is included, it should return -1. Otherwise, it should return the content of the response. I know the server above so I can test this. </p>
</li>
</ol>
<p>Just arbitrarily, I want my functions to define a good url as anything that ends with '.com' (Again, this is a toy, so I'm trying to keep it really simple.) I know that I'm doing TDD so I need to start with some tests. I will begin with a setUp() and some tests to test the basic_request() method.</p>
<p><em>requester_tests.py</em></p>
<pre><code class="python">import unittest
import requester as target

class TestRequester(unittest.TestCase):

   def setUp(self):
      self.url = 'http://computingconcepts.herokuapp.com'
      self.bad_url = 'http://computingconcepts.gopher'
      self.data = {
         'username': 'bobby', 
         'email': 'bobby@bobby.com'
      }

   def test_basic_request_bad_url(self):
      response = target.basic_request(self.bad_url)
      self.assertEqual(-1, response)

   def test_basic_request_good_url(self):
      response = target.basic_request(self.url)
      self.assertEqual(200, response)
</code></pre>

<p>I'll need to install the requests library, so I'll do that right now and create the file requester.py. I'll then run my tests. </p>
<pre><code>(env) $ touch requester.py
(env) $ pip install requests
(env) $ python -m unittest requester_tests.py
EE
======================================================================
ERROR: test_basic_request_bad_url (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;exercises/requester_tests.py&quot;, line 16, in 
  test_basic_request_bad_url
    response = target.basic_request(self.bad_url)
AttributeError: module 'requester' has no attribute 'basic_request'

======================================================================
ERROR: test_basic_request_good_url (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;exercises/requester_tests.py&quot;, line 20, in
   test_basic_request_good_url
    response = target.basic_request(self.url)
AttributeError: module 'requester' has no attribute 'basic_request'

----------------------------------------------------------------------
Ran 2 tests in 0.001s

FAILED (errors=2)
</code></pre>

<p>Of course we don't have anything in our file, so let's get it set up so that the tests fail the right way.</p>
<p><em>requester.py</em></p>
<pre><code class="python">import requests

def basic_request(url):
   pass
</code></pre>

<p>I know this will make my tests fail the right way because there is the correct function to call and it returns nothing. Sure enough, when I run my tests:</p>
<pre><code>$ python -m unittest requester_tests.py
FF
======================================================================
FAIL: test_basic_request_bad_url (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 17, in test_basic_request_bad_url
    self.assertEqual(-1, response)
AssertionError: -1 != None

======================================================================
FAIL: test_basic_request_good_url (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 21, in test_basic_request_good_url
    self.assertEqual(200, response)
AssertionError: 200 != None

----------------------------------------------------------------------
Ran 2 tests in 0.000s

FAILED (failures=2)
</code></pre>

<p>That's exactly the errors we want, so now we want to get it to pass. I know I want the function to check that the URL is valid first (by our silly arbitrary definition of valid as ending with .com). Second, I want it to use requests to call the valid URL. Third, I want to check the status code and return it if it is 200. If 200 is not the status code or there is a problem with the URL, we should return -1. I've done all that in the code below:</p>
<p><em>requester.py</em></p>
<pre><code class="python">import requests

def basic_request(url):
   if url[-4:] != '.com':
      return -1

   resp = requests.get(url)
   if resp.status_code == 200:
      return resp.status_code

   return -1
</code></pre>

<p>We run our tests and you'll notice that they hang for a minute on the second test. That's because Python waits on line requests line until it gets a response. The server we're calling is really wimpy, so this might take some time. On my machine, the tests take 10.451 seconds to run.</p>
<pre><code>$ python -m unittest requester_tests.py
.200
.
----------------------------------------------------------------------
Ran 2 tests in 10.451s

OK
</code></pre>

<p>Now we need to move on to our next function. We need to test that request_user_agent first checks the validity of the url. We also need to check that it returns -1 if the user agent is not set, and finally that it returns the content if the user agent is set. I've built the app on heroku specifically to do this. I know that if the user agent is 'DICE' the response will be 44260953. The idea is that you should be able to predict the output based on the input, and that's what you are testing.</p>
<p><em>requester_tests.py</em></p>
<pre><code class="python">import unittest
import requester as target

class TestRequester(unittest.TestCase):


   def setUp(self):
      self.url = 'https://computingconcepts.herokuapp.com'
      self.bad_url = 'https://computingconcepts.gopher'
      self.data = {
         'username': 'bobby',
         'email': 'bobby@bobby.com'
      }

   def test_basic_request_bad_url(self):
      response = target.basic_request(self.bad_url)
      self.assertEqual(-1, response)

   def test_basic_request_good_url(self):
      response = target.basic_request(self.url)
      self.assertEqual(200, response)      

   def test_user_agent_bad_url(self):
      resp = target.request_user_agent(self.bad_url, 'DICE')
      self.assertEqual(-1, resp)

   def test_user_agent_no_user_agent(self):
      resp = target.request_user_agent(self.url, None)
      self.assertEqual(-1, resp)

   def test_user_agent_success(self):
      resp = target.request_user_agent(self.url, 'DICE')
      self.assertEqual('44260953', resp)
</code></pre>

<p>I'm also going to quickly add a function to requester.py called request_user_agent() and have it pass so I don't have to go through the errors. We'll see that the tests fail.</p>
<pre><code>$ python -m unittest requester_tests.py
..FFF
======================================================================
FAIL: test_user_agent_bad_url (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 25, in test_user_agent_bad_url
    self.assertEqual(-1, resp)
AssertionError: -1 != None

======================================================================
FAIL: test_user_agent_no_user_agent (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 29, in test_user_agent_no_user_agent
    self.assertEqual(-1, resp)
AssertionError: -1 != None

======================================================================
FAIL: test_user_agent_success (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 33, in test_user_agent_success
    self.assertEqual(44260953, resp)
AssertionError: 44260953 != None

----------------------------------------------------------------------
Ran 5 tests in 5.449s

FAILED (failures=3)
</code></pre>

<p>So now we need to write the code to make these tests pass. We can copy our url check from basic_request() and maybe add some or logic to it to catch when our user_agent is None. Then we just need to handle the request. Please do take a moment to look at the documentation for requests to figure out how you might pass a user_agent to the request object.</p>
<p><em>requester.py</em></p>
<pre><code class="python">import requests

def basic_request(url):
   if url[-4:] != '.com':
      return -1


   resp = requests.get(url)

   if resp.status_code == 200:
      return resp.status_code

   return -1

def request_user_agent(url, agent):
   if url[-4:] != '.com' or agent == None:
      return -1

   headers = {
      'User-Agent': agent
   }

   resp = requests.get(url, headers = headers)

   if resp.status_code == 200:
      return resp.text

   return -1
</code></pre>

<p>What's interesting here is that I ran into an unexpected error. Initially I returned <code>resp.content</code> but that yielded these results:</p>
<pre><code>(env) $ python -m unittest requester_tests.py
....F
======================================================================
FAIL: test_user_agent_success (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 33, in test_user_agent_success
    self.assertEqual(44260953, resp)
AssertionError: 44260953 != b'44260953'

----------------------------------------------------------------------
Ran 5 tests in 9.271s

FAILED (failures=1)
</code></pre>

<p>I forgot that the data in the <code>content</code> is returned as bytes, so I had to use the <code>text</code> property instead. Now all my tests pass:</p>
<pre><code>(env) $ python -m unittest requester_tests.py
.....
----------------------------------------------------------------------
Ran 5 tests in 10.985s

OK
</code></pre>

<p>Now the last bit that we have to do is build our requests_post() function. Once again, I know that I need to test both of the parameters with the wrong data and both parameters with good data. However, instead of using the GET method, I know my function needs to call requests.post() instead. Again since I built the server to run tests against, I can predict the appropriate input and output for my function if it is working correctly. </p>
<p><em>requester_tests.py</em></p>
<pre><code class="python">import unittest
import requester as target

class TestRequester(unittest.TestCase):


   def setUp(self):
      self.url = 'https://computingconcepts.herokuapp.com'
      self.bad_url = 'https://computingconcepts.gopher'
      self.data = {
         'username': 'bobby',
         'email': 'bobby@bobby.com'
      }
      self.bad_data = {

      }

   def test_basic_request_bad_url(self):
      response = target.basic_request(self.bad_url)
      self.assertEqual(-1, response)

   def test_basic_request_good_url(self):
      response = target.basic_request(self.url)
      self.assertEqual(200, response)      

   def test_user_agent_bad_url(self):
      resp = target.request_user_agent(self.bad_url, 'DICE')
      self.assertEqual(-1, resp)

   def test_user_agent_no_user_agent(self):
      resp = target.request_user_agent(self.url, None)
      self.assertEqual(-1, resp)

   def test_user_agent_success(self):
      resp = target.request_user_agent(self.url, 'DICE')
      self.assertEqual('44260953', resp)

   def test_post_bad_url(self):
      resp = target.request_post(self.bad_url, self.data)
      self.assertEqual(-1, resp)

   def test_post_no_data(self):
      resp = target.request_post(self.url, None)
      self.assertEqual(-1, resp)

   def test_post_bad_data(self):
      data = {'username': 'bad', 'email':'bad'}
      resp = target.request_post(self.url, data)
      self.assertEqual(&quot;You didn't submit the right data&quot;, resp)

   def test_post_good_data(self):
      resp = target.request_post(self.url, self.data)
      self.assertEqual('44261853', resp)
</code></pre>

<p>Then we add the request_post() function to requester.py and run our tests:</p>
<pre><code>$ python -m unittest requester_tests.py
..FFFF...
======================================================================
FAIL: test_post_bad_data (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 49, in test_post_bad_data
    self.assertEqual(&quot;You didn't submit the right data&quot;, resp)
AssertionError: &quot;You didn't submit the right data&quot; != None

======================================================================
FAIL: test_post_bad_url (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 40, in test_post_bad_url
    self.assertEqual(-1, resp)
AssertionError: -1 != None

======================================================================
FAIL: test_post_good_data (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 53, in test_post_good_data
    self.assertEqual('44261853', resp)
AssertionError: '44261853' != None

======================================================================
FAIL: test_post_no_data (requester_tests.TestRequester)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/user1/SU/everyday/week3/exercises/requester_tests.py&quot;, line 44, in test_post_no_data
    self.assertEqual(-1, resp)
AssertionError: -1 != None

----------------------------------------------------------------------
Ran 9 tests in 0.733s

FAILED (failures=4)
</code></pre>

<p>Excellent! Again it's failing like we want it to fail. Again, I've set up my tests to fail in a particular way so that when they pass, I know the code is doing exactly what I want it to be doing. I'm going to build out the code next. Again, I leave you to read up on how to send data with requests. It uses the post() method. </p>
<p><em>requester.py</em></p>
<pre><code class="python">import requests

def basic_request(url):
   if url[-4:] != '.com':
      return -1


   resp = requests.get(url)

   if resp.status_code == 200:
      return resp.status_code

   return -1

def request_user_agent(url, agent):
   if url[-4:] != '.com' or agent == None:
      return -1

   headers = {
      'User-Agent': agent
   }

   resp = requests.get(url, headers = headers)

   if resp.status_code == 200:
      return resp.text

   return -1

def request_post(url, data):
   if url[-4:] != '.com' or data == None:
      return -1
   url = url + '/post'
   resp = requests.post(url, data = data)

   if resp.status_code == 200:
      return resp.text

   return -1 
</code></pre>

<p>You'll notice that I'm concatenating '/post' to the url so that the right resource is being called by the request. Then we run our tests and we're good to go.</p>
<pre><code>(env) $ python -m unittest requester_tests.py
.........
----------------------------------------------------------------------
Ran 9 tests in 2.363s

OK
</code></pre>

<p>In the next chapter we'll finally be able to get into building our Flask app with TDD. We'll be building a miniature blog over the remaining chapters.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
